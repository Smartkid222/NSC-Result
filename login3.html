<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Result Management System</title>
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .w-full { width: 100%; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* --- BUTTONS --- */
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px;}
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-outline { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background-color: #eff6ff; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }

        /* --- AUTH VIEW STYLES --- */
        .auth-wrapper {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-container {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .auth-header { text-align: center; padding: 0; border-bottom: 1px solid #eee; }
        .app-title { padding: 20px 0 10px; font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .tabs { display: flex; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #f8f9fa; cursor: pointer; color: #777; transition: 0.3s; border-bottom: 2px solid transparent; }
        .tab-btn.active { background: white; color: var(--primary); border-bottom: 2px solid var(--primary); }
        .forms-wrapper { padding: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: #555; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: var(--radius); font-size: 1rem; transition: border 0.3s; }
        .form-control:focus { border-color: var(--primary); }
        
        .name-row { display: flex; gap: 10px; }
        .name-row .form-group { flex: 1; }
        .subject-builder { background: #f8fafc; padding: 15px; border-radius: var(--radius); border: 1px dashed #cbd5e1; margin-bottom: 15px; }
        .chip-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .subject-chip { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
        .chip-remove { cursor: pointer; font-weight: bold; color: #dc2626; }
        .chip-remove:hover { color: #b91c1c; }

        /* --- DASHBOARD VIEW STYLES --- */
        header { background: var(--surface); padding: 1rem 2rem; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Cards & Grid */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--surface); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); transition: transform 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-4px); border-color: var(--primary); }
        .card-lg { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; padding: 30px; border-left: 5px solid var(--primary); background: linear-gradient(to right, #fff, #f8fafc); }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-jss { background: #e0f2fe; color: #0369a1; }
        .badge-sss { background: #fef3c7; color: #b45309; }

        /* Tables */
        .table-container { overflow-x: auto; background: var(--surface); border-radius: 8px; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; font-weight: 600; color: var(--secondary); font-size: 0.9rem; white-space: nowrap; }
        tr:hover { background: #f1f5f9; }
        
        .score-input-mini { width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        .score-input-mini:focus { border-color: var(--primary); outline: none; }
        .total-mini { font-weight: bold; display: inline-block; width: 40px; text-align: center; }

        /* Student Detail View */
        .score-card { background: var(--surface); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .score-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .avatar { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
        
        .score-row { display: grid; grid-template-columns: 2fr 1fr 1fr 80px; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .score-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; text-align: center; }
        .score-input:disabled { background: #f8fafc; color: #94a3b8; cursor: not-allowed; border-color: transparent; }
        .subject-label { font-weight: 500; display: flex; flex-direction: column; }
        .readonly-badge { font-size: 0.7rem; color: var(--secondary); font-weight: normal; font-style: italic; }
        
        /* Modals & Toasts */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 10px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2000; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .toast.show { transform: translateY(0); }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }

        .breadcrumbs { font-size: 0.9rem; color: var(--secondary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .breadcrumbs span { cursor: pointer; }
        .breadcrumbs span:hover { color: var(--primary); text-decoration: underline; }
        .breadcrumbs span:last-child { cursor: default; color: var(--text); font-weight: 600; text-decoration: none; }

        /* Print Styles */
        #printable-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { display: block; position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; font-family: 'Times New Roman', serif; }
            .rp-header { text-align: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
            .rp-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .rp-table th, .rp-table td { border: 1px solid #000; padding: 8px; text-align: center; }
        }
    </style>
</head>
<body>

    <!-- ================= AUTH VIEW ================= -->
    <div id="view-auth" class="auth-wrapper">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="app-title">Teacher Portal</h1>
                <div class="tabs">
                    <button class="tab-btn active" onclick="app.switchAuthTab('login')">Login</button>
                    <button class="tab-btn" onclick="app.switchAuthTab('signup')">Sign Up</button>
                </div>
            </div>

            <div class="forms-wrapper">
                <!-- LOGIN FORM -->
                <form id="form-login" onsubmit="app.handleLogin(event)">
                    <div class="name-row">
                        <div class="form-group">
                            <label>Title</label>
                            <select id="loginTitle" class="form-control">
                                <option value="Mr.">Mr.</option>
                                <option value="Mrs.">Mrs.</option>
                                <option value="Miss">Miss</option>
                                <option value="Dr.">Dr.</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="loginFirstName" class="form-control" placeholder="First" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="loginLastName" class="form-control" placeholder="Last" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPass" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login to Dashboard</button>
                </form>

                <!-- SIGNUP FORM -->
                <form id="form-signup" class="hidden" onsubmit="app.handleSignup(event)">
                    <div class="form-group">
                        <label>Role</label>
                        <select id="signupRole" class="form-control" onchange="app.handleRoleChange()" required>
                            <option value="Teacher">Teacher</option>
                            <option value="Class Teacher">Class Teacher</option>
                            <option value="Admin">Admin</option>
                            <option value="Head">Head</option>
                        </select>
                    </div>
                    <div class="name-row">
                        <div class="form-group">
                            <label>Title</label>
                            <select id="signupTitle" class="form-control">
                                <option value="Mr.">Mr.</option>
                                <option value="Mrs.">Mrs.</option>
                                <option value="Miss">Miss</option>
                                <option value="Dr.">Dr.</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="signupFirstName" class="form-control" placeholder="First" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="signupLastName" class="form-control" placeholder="Last" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPass" class="form-control" required>
                    </div>

                    <div id="class-teacher-group" class="hidden form-group">
                        <label>Assigned Class (As Class Teacher)</label>
                        <select id="signupClass" class="form-control">
                            <option value="" disabled selected>Select Class</option>
                            <option value="JSS1">JSS1</option><option value="JSS2">JSS2</option><option value="JSS3">JSS3</option>
                            <option value="SSS1">SSS1</option><option value="SSS2">SSS2</option><option value="SSS3">SSS3</option>
                        </select>
                    </div>

                    <div id="subject-group">
                        <div class="subject-builder">
                            <label style="margin-bottom:8px; display:block;">Subjects Taught</label>
                            <div class="flex gap-2">
                                <select id="subjectLevel" class="form-control" onchange="app.populateSubjects()">
                                    <option value="" disabled selected>Level</option>
                                    <option value="JSS">JSS</option>
                                    <option value="SSS">SSS</option>
                                </select>
                                <select id="subjectName" class="form-control">
                                    <option value="" disabled selected>Subject</option>
                                </select>
                                <select id="subjectClass" class="form-control">
                                    <option value="" disabled selected>Class</option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="app.addSubject()">+</button>
                            </div>
                            <div id="chipList" class="chip-list"></div>
                            <small id="subjectError" style="color:var(--danger); display:none;">Add at least one subject</small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================= DASHBOARD VIEW ================= -->
    <div id="view-dashboard" class="hidden">
        <header>
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                EduManager
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div id="user-display-name" class="font-bold">Teacher Name</div>
                    <div id="user-display-role" class="text-sm text-secondary">Role</div>
                </div>
                <button class="btn btn-outline btn-sm" onclick="app.logout()">Logout</button>
            </div>
        </header>

        <main class="container">
            
            <!-- 1. DASHBOARD LANDING (Changes based on Role) -->
            <section id="section-landing">
                <!-- Injected via JS -->
            </section>

            <!-- 2. CLASS LIST (For Subject Teachers / Admin Manage Students) -->
            <section id="section-class-list" class="hidden">
                <div class="breadcrumbs">
                    <span onclick="app.goHome()">Home</span> > <span id="breadcrumb-action">Classes</span>
                </div>
                <h2 id="list-title" style="margin-bottom:15px;">Classes</h2>
                <div class="dashboard-grid" id="class-grid"></div>
            </section>

            <!-- 3. SUBJECT LIST (Select Subject within a Class) -->
            <section id="section-subject-list" class="hidden">
                <div class="breadcrumbs">
                    <span onclick="app.goHome()">Home</span> > <span id="crumb-cls-action">Classes</span> > <span id="crumb-class-name"></span>
                </div>
                <h2 style="margin-bottom:15px;">Select Subject</h2>
                <div class="dashboard-grid" id="subject-grid"></div>
            </section>

            <!-- 4. BATCH SCORE ENTRY (Subject-based: Class -> Subject -> Students) -->
            <section id="section-batch-entry" class="hidden">
                <div class="breadcrumbs">
                    <span onclick="app.goHome()">Home</span> > <span id="batch-crumb-class"></span> > <span id="batch-crumb-subject"></span>
                </div>
                <div class="flex justify-between items-center" style="margin-bottom:20px;">
                    <h2>Student Scores</h2>
                    <div id="batch-actions">
                        <!-- Add Student button for Admin -->
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Admin No</th><th>Name</th><th>CA (40)</th><th>Exam (60)</th><th>Total (100)</th></tr></thead>
                        <tbody id="batch-rows"></tbody>
                    </table>
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button class="btn btn-primary" onclick="app.saveBatchScores()">Save All Scores</button>
                </div>
            </section>

            <!-- 5. STUDENT LIST (For Class Teachers / Admin Check Scores) -->
            <section id="section-student-list" class="hidden">
                <div class="breadcrumbs">
                    <span onclick="app.goHome()">Home</span> > <span id="std-list-crumb-cls"></span>
                </div>
                <div class="flex justify-between items-center" style="margin-bottom:20px;">
                    <h2>Students</h2>
                    <input type="text" id="std-search" class="form-control" placeholder="Search..." style="width:200px;" onkeyup="app.filterStudentList()">
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Admin No</th><th>Name</th><th>Action</th></tr></thead>
                        <tbody id="std-list-rows"></tbody>
                    </table>
                </div>
            </section>

            <!-- 6. STUDENT DETAIL (All subjects for one student) -->
            <section id="section-student-detail" class="hidden">
                <div class="breadcrumbs">
                    <span onclick="app.goHome()">Home</span> > <span id="det-crumb-cls"></span> > <span id="det-crumb-name"></span>
                </div>
                <div class="score-card">
                    <div class="score-header">
                        <div class="avatar" id="det-avatar">?</div>
                        <div>
                            <h2 id="det-name">Student Name</h2>
                            <p class="text-secondary" id="det-info">Class Info</p>
                        </div>
                    </div>
                    <form onsubmit="event.preventDefault(); app.saveStudentDetail();">
                        <div id="det-score-rows"></div>
                        <div class="flex justify-between" style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                            <button type="button" class="btn btn-outline" onclick="app.closeStudentDetail()">Back</button>
                            <div class="flex gap-2">
                                <button type="button" class="btn btn-outline" onclick="app.openPrintModal()">Print</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <!-- ================= MODALS ================= -->
    <div id="modal-add-student" class="modal-overlay">
        <div class="modal">
            <h3>Add New Student</h3>
            <div class="form-group"><label>Full Name</label><input type="text" id="newStdName" class="form-control"></div>
            <div class="form-group"><label>Admin ID</label><input type="text" id="newStdId" class="form-control"></div>
            <div class="form-group"><label>Gender</label><select id="newStdGender" class="form-control"><option>Male</option><option>Female</option></select></div>
            <div id="modal-dept-group" class="form-group hidden">
                <label>Department</label>
                <select id="newStdDept" class="form-control"><option value="Science">Science</option><option value="Art">Art</option><option value="Commercial">Commercial</option></select>
            </div>
            <div class="flex justify-between" style="margin-top:20px;">
                <button class="btn btn-outline" onclick="app.closeModals()">Cancel</button>
                <button class="btn btn-primary" onclick="app.addStudentConfirm()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-print" class="modal-overlay">
        <div class="modal">
            <h3>Print Configuration</h3>
            <div class="form-group"><label>Session</label><input type="text" id="printSession" value="2024/2025" class="form-control"></div>
            <div class="form-group"><label>Term</label><select id="printTerm" class="form-control"><option>1st</option><option>2nd</option><option>3rd</option></select></div>
            <div class="form-group"><label>Comment</label><textarea id="printComment" class="form-control" rows="3"></textarea></div>
            <div class="flex justify-between" style="margin-top:20px;">
                <button class="btn btn-outline" onclick="app.closeModals()">Cancel</button>
                <button class="btn btn-primary" onclick="app.printReport()">Print</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"><span id="toast-msg"></span></div>
    <div id="printable-area"></div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- CONSTANTS & DB ---
        const GOOGLE_SCRIPT_URL = ''; // Demo Mode
        const SUBJECTS = {
            JSS: ['English', 'Mathematics', 'Basic Science', 'Social Studies', 'Civic Ed', 'PHE', 'BST', 'Creative Arts', 'Yoruba', 'French'],
            SSS: ['English', 'Mathematics', 'Physics', 'Chemistry', 'Biology', 'Economics', 'Geography', 'Literature', 'Government']
        };
        const ALL_CLASSES = ['JSS1','JSS2','JSS3','SSS1','SSS2','SSS3'];

        const MockDB = {
            users: [],
            students: [
                { id:'1001', name:'John Doe', class:'JSS1', gender:'Male', scores: { English:{ca:20,exam:30}, Math:{ca:15,exam:25} } },
                { id:'1002', name:'Jane Smith', class:'JSS1', gender:'Female', scores: { English:{ca:25,exam:35}, Math:{ca:20,exam:30} } },
                { id:'1003', name:'Emeka Okafor', class:'JSS2', gender:'Male', scores: { English:{ca:10,exam:20}, Math:{ca:15,exam:15} } },
                { id:'1004', name:'Chioma Adebayo', class:'JSS3', gender:'Female', scores: { English:{ca:30,exam:40}, Math:{ca:30,exam:30} } }
            ],
            init: function() {
                const u = localStorage.getItem('edu_users');
                if(u) this.users = JSON.parse(u);
                else {
                    this.users.push({ name:'Mr. Admin User', firstName:'Admin', lastName:'User', title:'Mr.', pass:'admin123', role:'Admin', subjects:[], assignedClass:'' });
                    this.save();
                }
                const s = localStorage.getItem('edu_students');
                if(s) this.students = JSON.parse(s);
            },
            save: function() {
                localStorage.setItem('edu_users', JSON.stringify(this.users));
                localStorage.setItem('edu_students', JSON.stringify(this.students));
            },
            findUser: function(n, p) { return this.users.find(u => u.name.toLowerCase()===n.toLowerCase() && u.pass===p); },
            addUser: function(u) { this.users.push(u); this.save(); },
            addStudent: function(s) { this.students.push(s); this.save(); },
            updateScores: function(id, scores) {
                const idx = this.students.findIndex(x => x.id === id);
                if(idx>-1) { this.students[idx].scores = scores; this.save(); }
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            state: {
                currentUser: null,
                viewContext: {}, // Stores { class, subject, mode }
                draftSubjects: []
            },

            init: function() {
                MockDB.init();
                const u = sessionStorage.getItem('currentUser');
                if(u) {
                    this.state.currentUser = JSON.parse(u);
                    this.showDashboard();
                } else document.getElementById('view-auth').classList.remove('hidden');
                this.populateSubjects();
            },

            // --- AUTH ---
            switchAuthTab: function(t) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('form-login').classList.toggle('hidden', t!=='login');
                document.getElementById('form-signup').classList.toggle('hidden', t!=='signup');
            },
            handleRoleChange: function() {
                const r = document.getElementById('signupRole').value;
                document.getElementById('class-teacher-group').classList.toggle('hidden', r!=='Class Teacher');
                document.getElementById('subject-group').classList.toggle('hidden', r==='Admin'||r==='Head');
            },
            populateSubjects: function() {
                const l = document.getElementById('subjectLevel').value;
                const s = document.getElementById('subjectName');
                const c = document.getElementById('subjectClass');
                s.innerHTML = '<option disabled selected>Subject</option>';
                c.innerHTML = '<option disabled selected>Class</option>';
                if(!l) return;
                SUBJECTS[l].forEach(sub => s.innerHTML += `<option value="${sub}">${sub}</option>`);
                if(l==='JSS') c.innerHTML += `<option value="ALL JSS">ALL JSS</option><option value="JSS1">JSS1</option><option value="JSS2">JSS2</option><option value="JSS3">JSS3</option>`;
                else c.innerHTML += `<option value="ALL SSS">ALL SSS</option><option value="SSS1">SSS1</option><option value="SSS2">SSS2</option><option value="SSS3">SSS3</option>`;
            },
            addSubject: function() {
                const s = document.getElementById('subjectName').value;
                const c = document.getElementById('subjectClass').value;
                if(!s||!c) return this.showToast('Select subject and class', 'error');
                this.state.draftSubjects.push({subject:s, class:c});
                this.renderChips();
            },
            renderChips: function() {
                const l = document.getElementById('chipList');
                l.innerHTML = this.state.draftSubjects.map((x,i) => `<div class="subject-chip">${x.subject} (${x.class}) <span onclick="app.state.draftSubjects.splice(${i},1);app.renderChips()">&times;</span></div>`).join('');
            },
            handleSignup: function(e) {
                e.preventDefault();
                const title = document.getElementById('signupTitle').value;
                const fname = document.getElementById('signupFirstName').value;
                const lname = document.getElementById('signupLastName').value;
                const role = document.getElementById('signupRole').value;
                let cls = role==='Class Teacher' ? document.getElementById('signupClass').value : '';
                if(role==='Class Teacher' && !cls) return this.showToast('Select assigned class', 'error');
                if(role==='Teacher' && this.state.draftSubjects.length===0) return this.showToast('Add subject', 'error');
                
                const u = { name:`${title} ${fname} ${lname}`, firstName:fname, lastName:lname, title:title, pass:document.getElementById('signupPass').value, role, assignedClass:cls, subjects:[...this.state.draftSubjects] };
                MockDB.addUser(u);
                this.showToast('Created! Login.', 'success');
                this.switchAuthTab('login');
                this.state.draftSubjects=[];
                document.getElementById('form-signup').reset();
            },
            handleLogin: function(e) {
                e.preventDefault();
                const title = document.getElementById('loginTitle').value;
                const fname = document.getElementById('loginFirstName').value;
                const lname = document.getElementById('loginLastName').value;
                const pass = document.getElementById('loginPass').value;
                const name = `${title} ${fname} ${lname}`;
                const u = MockDB.findUser(name, pass);
                if(u) {
                    this.state.currentUser = u;
                    sessionStorage.setItem('currentUser', JSON.stringify(u));
                    this.showToast('Welcome!', 'success');
                    setTimeout(() => this.showDashboard(), 500);
                } else this.showToast('Invalid credentials', 'error');
            },
            logout: function() {
                sessionStorage.removeItem('currentUser');
                window.location.reload();
            },

            // --- DASHBOARD & NAVIGATION ---
            showDashboard: function() {
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('user-display-name').textContent = this.state.currentUser.name;
                document.getElementById('user-display-role').textContent = this.state.currentUser.role + (this.state.currentUser.assignedClass ? ` (${this.state.currentUser.assignedClass})` : '');
                
                this.renderLanding();
            },

            renderLanding: function() {
                const r = this.state.currentUser.role;
                const land = document.getElementById('section-landing');
                land.innerHTML = '';

                // 1. TEACHER (Subject Only)
                if(r === 'Teacher') {
                    land.innerHTML = `<h2 style="margin-bottom:15px;">My Classes</h2><div id="landing-grid" class="dashboard-grid"></div>`;
                    this.renderClassCards('landing-grid', false);
                }
                // 2. CLASS TEACHER (Hybrid)
                else if(r === 'Class Teacher') {
                    land.innerHTML = `
                        <div class="card card-lg" onclick="app.loadStudentList('${this.state.currentUser.assignedClass}', 'ClassTeacher')">
                            <div><h2 style="color:var(--primary);">My Class</h2><p class="text-secondary">View results for ${this.state.currentUser.assignedClass}</p></div>
                            <div style="font-size:2rem;">üè´</div>
                        </div>
                        <h3 style="margin:20px 0 10px;">Other Classes (Teaching)</h3>
                        <div id="landing-grid" class="dashboard-grid"></div>
                    `;
                    this.renderClassCards('landing-grid', true);
                }
                // 3. ADMIN / HEAD (Two Sections)
                else {
                    land.innerHTML = `
                        <div class="grid-2">
                            <div class="card card-lg" onclick="app.enterAdminMode('manage')" style="border-left-color:var(--success);">
                                <div><h2 style="color:var(--success);">Manage Students</h2><p class="text-secondary">Add students & Enter Scores by Subject</p></div>
                                <div style="font-size:2rem;">üìÇ</div>
                            </div>
                            <div class="card card-lg" onclick="app.enterAdminMode('check')" style="border-left-color:var(--warning);">
                                <div><h2 style="color:var(--warning);">Check Scores</h2><p class="text-secondary">View Student Profiles & Results</p></div>
                                <div style="font-size:2rem;">üìä</div>
                            </div>
                        </div>
                    `;
                }
            },

            // Renders Class Cards based on Subject List
            renderClassCards: function(containerId, excludeAssigned) {
                const cont = document.getElementById(containerId);
                if(!cont) return;
                
                const visibleClasses = new Set();
                this.state.currentUser.subjects.forEach(s => {
                    if(s.class==='ALL JSS') ['JSS1','JSS2','JSS3'].forEach(c=>visibleClasses.add(c));
                    else if(s.class==='ALL SSS') ['SSS1','SSS2','SSS3'].forEach(c=>visibleClasses.add(c));
                    else visibleClasses.add(s.class);
                });

                // If Class Teacher, exclude their own class from this list to avoid duplication if they don't teach there
                if(excludeAssigned) visibleClasses.delete(this.state.currentUser.assignedClass);

                Array.from(visibleClasses).sort().forEach(cls => {
                    const isJSS = cls.startsWith('JSS');
                    cont.innerHTML += `
                        <div class="card" onclick="app.loadSubjectList('${cls}')">
                            <div class="flex justify-between">
                                <h3>${cls}</h3>
                                <span class="badge ${isJSS?'badge-jss':'badge-sss'}">${isJSS?'JSS':'SSS'}</span>
                            </div>
                            <p class="text-secondary">Select Subject to Enter Scores</p>
                        </div>`;
                });
            },

            // --- FLOWS ---

            // 1. TEACHER / ADMIN MANAGE: Select Class
            enterAdminMode: function(mode) {
                // If Admin "Manage Students", show Class Grid
                // If Admin "Check Scores", show Class Grid (logic differs slightly in loadClassList)
                this.state.viewContext.mode = mode;
                if(mode === 'manage') {
                    document.getElementById('list-title').textContent = "Select Class to Manage";
                    document.getElementById('breadcrumb-action').textContent = "Manage Students";
                    document.getElementById('class-grid').innerHTML = '';
                    ALL_CLASSES.forEach(cls => {
                         document.getElementById('class-grid').innerHTML += `<div class="card" onclick="app.loadSubjectList('${cls}')"><h3>${cls}</h3></div>`;
                    });
                    this.showSection('section-class-list');
                } else {
                    // "Check Scores" goes directly to selecting class to view students
                    document.getElementById('list-title').textContent = "Select Class to View";
                    document.getElementById('breadcrumb-action').textContent = "Check Scores";
                    document.getElementById('class-grid').innerHTML = '';
                    ALL_CLASSES.forEach(cls => {
                         document.getElementById('class-grid').innerHTML += `<div class="card" onclick="app.loadStudentList('${cls}', 'Admin')"><h3>${cls}</h3></div>`;
                    });
                    this.showSection('section-class-list');
                }
            },

            // 2. SELECT SUBJECT LIST (Used by Teacher, Class Teacher, Admin Manage)
            loadSubjectList: function(clsName) {
                this.state.viewContext.cls = clsName;
                document.getElementById('crumb-class-name').textContent = clsName;
                const grid = document.getElementById('subject-grid');
                grid.innerHTML = '';

                // Filter subjects user teaches in this class
                const subs = this.state.currentUser.subjects
                    .filter(s => s.class === clsName || (s.class === 'ALL JSS' && clsName.startsWith('JSS')) || (s.class === 'ALL SSS' && clsName.startsWith('SSS')))
                    .map(s => s.subject);

                // Remove duplicates
                const uniqueSubs = [...new Set(subs)];

                if(uniqueSubs.length === 0) {
                    grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">You do not teach any subject in this class.</p>';
                } else {
                    uniqueSubs.forEach(sub => {
                        grid.innerHTML += `<div class="card" onclick="app.loadBatchEntry('${clsName}', '${sub}')"><h3>${sub}</h3><p>Enter Scores</p></div>`;
                    });
                }
                this.showSection('section-subject-list');
            },

            // 3. BATCH ENTRY (The core Subject-Based flow)
            loadBatchEntry: function(cls, sub) {
                this.state.viewContext.cls = cls;
                this.state.viewContext.sub = sub;
                document.getElementById('batch-crumb-class').textContent = cls;
                document.getElementById('batch-crumb-subject').textContent = sub;

                // Show Add Button only if Admin
                const acts = document.getElementById('batch-actions');
                acts.innerHTML = this.state.currentUser.role === 'Admin' ? `<button class="btn btn-primary" onclick="app.openAddStudentModal('${cls}')">+ Add Student</button>` : '';

                const tbody = document.getElementById('batch-rows');
                tbody.innerHTML = '';
                const stds = MockDB.students.filter(s => s.class === cls);
                
                stds.forEach(s => {
                    const score = s.scores[sub] || {ca:'', exam:''};
                    const total = (parseInt(score.ca)||0) + (parseInt(score.exam)||0);
                    tbody.innerHTML += `
                        <tr data-sid="${s.id}">
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td><input type="number" class="score-input-mini input-ca" min="0" max="40" value="${score.ca}"></td>
                            <td><input type="number" class="score-input-mini input-exam" min="0" max="60" value="${score.exam}"></td>
                            <td><span class="total-mini">${total}</span></td>
                        </tr>
                    `;
                });

                // Auto calc listeners
                document.querySelectorAll('.score-input-mini').forEach(inp => {
                    inp.addEventListener('input', e => {
                        const r = e.target.closest('tr');
                        const ca = parseInt(r.querySelector('.input-ca').value)||0;
                        const ex = parseInt(r.querySelector('.input-exam').value)||0;
                        r.querySelector('.total-mini').textContent = ca + ex;
                    });
                });

                this.showSection('section-batch-entry');
            },

            saveBatchScores: function() {
                const rows = document.querySelectorAll('#batch-rows tr');
                const sub = this.state.viewContext.sub;
                
                rows.forEach(r => {
                    const sid = r.getAttribute('data-sid');
                    const ca = r.querySelector('.input-ca').value;
                    const ex = r.querySelector('.input-exam').value;
                    
                    // Get current student data
                    const sIdx = MockDB.students.findIndex(x => x.id === sid);
                    if(sIdx > -1) {
                        // Update specific subject score
                        if(!MockDB.students[sIdx].scores) MockDB.students[sIdx].scores = {};
                        MockDB.students[sIdx].scores[sub] = { ca: parseInt(ca)||0, exam: parseInt(ex)||0 };
                    }
                });
                MockDB.save();
                this.showToast('Scores saved successfully', 'success');
            },

            // 4. STUDENT LIST (For Class Teacher / Admin Check Scores)
            loadStudentList: function(cls, mode) {
                this.state.viewContext.cls = cls;
                this.state.viewContext.mode = mode; // 'ClassTeacher' or 'Admin'
                document.getElementById('std-list-crumb-cls').textContent = cls;

                const tbody = document.getElementById('std-list-rows');
                tbody.innerHTML = '';
                const stds = MockDB.students.filter(s => s.class === cls);
                
                stds.forEach(s => {
                    tbody.innerHTML += `<tr><td>${s.id}</td><td>${s.name}</td><td><button class="btn btn-sm btn-outline" onclick="app.loadStudentDetail('${s.id}')">View Profile</button></td></tr>`;
                });
                this.showSection('section-student-list');
            },

            filterStudentList: function() {
                const q = document.getElementById('std-search').value.toLowerCase();
                const rows = document.querySelectorAll('#std-list-rows tr');
                rows.forEach(r => {
                    r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
                });
            },

            // 5. STUDENT DETAIL (All subjects, Permission based editing)
            loadStudentDetail: function(sid) {
                const s = MockDB.students.find(x => x.id === sid);
                if(!s) return;
                this.state.viewContext.sid = sid;
                
                document.getElementById('det-crumb-cls').textContent = s.class;
                document.getElementById('det-crumb-name').textContent = s.name;
                document.getElementById('det-name').textContent = s.name;
                document.getElementById('det-info').textContent = `ID: ${s.id}`;
                document.getElementById('det-avatar').textContent = s.name.substring(0,2).toUpperCase();

                const u = this.state.currentUser;
                const isJSS = s.class.startsWith('JSS');
                const allSubs = isJSS ? SUBJECTS.JSS : SUBJECTS.SSS;

                const container = document.getElementById('det-score-rows');
                container.innerHTML = '';

                // LOGIC: Admin sees all & edits all. CT sees all & edits own. Teacher doesn't see this view (mostly).
                allSubs.forEach(sub => {
                    const score = s.scores[sub] || {ca:'', exam:''};
                    const total = (parseInt(score.ca)||0) + (parseInt(score.exam)||0);

                    // Permission
                    let canEdit = false;
                    if(u.role === 'Admin' || u.role === 'Head') canEdit = true;
                    else if (u.role === 'Class Teacher' && u.subjects.some(subj => subj.subject === sub)) canEdit = true;

                    const ro = canEdit ? '' : 'disabled';
                    const lbl = !canEdit ? '<span class="readonly-badge">Read-only</span>' : '';

                    container.innerHTML += `
                        <div class="score-row">
                            <div class="subject-label">${sub} ${lbl}</div>
                            <div><input type="number" class="score-input input-ca" min="0" max="40" value="${score.ca}" ${ro}></div>
                            <div><input type="number" class="score-input input-exam" min="0" max="60" value="${score.exam}" ${ro}></div>
                            <div style="font-weight:bold;text-align:center;">${total||'-'}</div>
                        </div>
                    `;
                });
                
                // Listeners
                document.querySelectorAll('.score-input').forEach(inp => {
                    inp.addEventListener('input', e => {
                        const r = e.target.closest('.score-row');
                        const ca = r.querySelector('.input-ca').value;
                        const ex = r.querySelector('.input-exam').value;
                        r.lastElementChild.textContent = (parseInt(ca)||0)+(parseInt(ex)||0);
                    });
                });

                this.showSection('section-student-detail');
            },

            saveStudentDetail: function() {
                const sid = this.state.viewContext.sid;
                const u = this.state.currentUser;
                const rows = document.querySelectorAll('#det-score-rows .score-row');
                const updates = {};

                rows.forEach(r => {
                    const labelDiv = r.querySelector('.subject-label');
                    const sub = labelDiv.firstChild.textContent.trim();
                    const ca = r.querySelector('.input-ca').value;
                    const ex = r.querySelector('.input-exam').value;

                    // Backend permission check (Simulated)
                    let canEdit = false;
                    if(u.role==='Admin'||u.role==='Head') canEdit = true;
                    else if(u.role==='Class Teacher' && u.subjects.some(s=>s.subject===sub)) canEdit = true;

                    if(canEdit) {
                        updates[sub] = { ca: parseInt(ca)||0, exam: parseInt(ex)||0 };
                    }
                });

                // Merge with existing scores
                const sIdx = MockDB.students.findIndex(x => x.id === sid);
                if(sIdx > -1) {
                    MockDB.students[sIdx].scores = { ...MockDB.students[sIdx].scores, ...updates };
                    MockDB.save();
                    this.showToast('Changes Saved', 'success');
                }
            },

            closeStudentDetail: function() {
                // If Class Teacher, go back to Student List. If Admin (Check Score), go back to Student List.
                this.loadStudentList(this.state.viewContext.cls, this.state.viewContext.mode);
            },

            // --- UTILS ---
            showSection: function(id) {
                document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            },
            goHome: function() {
                this.showSection('section-landing');
            },
            openAddStudentModal: function(cls) {
                this.state.viewContext.tempClass = cls;
                document.getElementById('modal-add-student').style.display = 'flex';
                document.getElementById('modal-dept-group').classList.toggle('hidden', !cls.startsWith('SSS'));
            },
            addStudentConfirm: function() {
                const name = document.getElementById('newStdName').value;
                const id = document.getElementById('newStdId').value;
                const gender = document.getElementById('newStdGender').value;
                const dept = document.getElementById('newStdDept').value;
                if(!name||!id) return this.showToast('Missing fields', 'error');

                MockDB.addStudent({
                    id, name, gender,
                    class: this.state.viewContext.tempClass,
                    dept: this.state.viewContext.tempClass.startsWith('SSS') ? dept : '',
                    scores: {}
                });
                this.showToast('Student Added', 'success');
                this.closeModals();
                // Refresh current view
                if(this.state.viewContext.sub) this.loadBatchEntry(this.state.viewContext.cls, this.state.viewContext.sub);
                else this.loadStudentList(this.state.viewContext.cls, 'Admin');
            },
            openPrintModal: function() {
                document.getElementById('modal-print').style.display='flex';
            },
            closeModals: function() {
                document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none');
            },
            printReport: function() {
                const s = MockDB.students.find(x => x.id === this.state.viewContext.sid);
                const area = document.getElementById('printable-area');
                area.innerHTML = `
                    <div class="rp-header"><h2>NIFTY STEPS COLLEGE</h2><h3>REPORT SHEET</h3></div>
                    <p><strong>Name:</strong> ${s.name} | <strong>Class:</strong> ${s.class}</p>
                    <table class="rp-table">
                        <thead><tr><th>Subject</th><th>CA</th><th>Exam</th><th>Total</th></tr></thead>
                        <tbody>
                            ${(s.class.startsWith('JSS')?SUBJECTS.JSS:SUBJECTS.SSS).map(sub => {
                                const sc = s.scores[sub]||{ca:0,exam:0};
                                return `<tr><td>${sub}</td><td>${sc.ca}</td><td>${sc.exam}</td><td>${sc.ca+sc.exam}</td></tr>`
                            }).join('')}
                        </tbody>
                    </table>
                `;
                this.closeModals();
                window.print();
            },
            showToast: function(m, t) {
                const x = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = m;
                x.className = `toast show ${t}`;
                setTimeout(()=>x.classList.remove('show'), 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>